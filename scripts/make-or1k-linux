#!/bin/bash

or1k_utils=$HOME/work/openrisc/or1k-utils
openadk=$HOME/work/openrisc/openadk
hdmi2usb=$HOME/work/litex/HDMI2USB-litex-firmware
litexbuild=$HOME/work/litex/litex-buildenv

openadk_source="$openadk/target_qemu-or1k_uclibc-ng/qemu-or1k-uclibc-ng-initramfspiggyback_list"
or1k_utils_source="$or1k_utils/initramfs $or1k_utils/initramfs.devnodes"

toolchain=or1k-elf-
#toolchain=or1k-linux-musl-
#toolchain=or1k-linux-

# Select one of these to choose your preferred initramfs
initramfs_source=$or1k_utils_source
#initramfs_source=$openadk_source

cflags="-O3 -mhard-mul -I/opt/shorne/software/or1k-elf/include"

run() {
  echo "exec: $@"
  "$@"
}

(
  cd $HOME/work/linux
  run make -j5 ARCH=openrisc \
     CFLAGS="${cflags}" \
     CROSS_COMPILE=${toolchain} \
     $@
     # CONFIG_INITRAMFS_SOURCE="$initramfs_source" \

#  echo "Generating initramfs.cpio.gz ..."
#  ./usr/gen_initramfs.sh -o initramfs.cpio -u squash -g squash $initramfs_source
#  gzip -f initramfs.cpio
)

run mkdir -p $litexbuild/build/tftpd
run ${toolchain}objcopy -O binary vmlinux $litexbuild/build/tftpd/boot.bin

#run mkdir -p $hdmi2usb/build/arty_net_or1k/software/linux
#run cp arch/openrisc/boot/vmlinux.bin $hdmi2usb/build/arty_net_or1k/software/linux/firmware.bin
# make ARCH=openrisc INSTALL_HDR_PATH=/opt/shorne/software/or1k-linux headers_install
